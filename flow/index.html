<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flow | Shop</title>
    <!-- Supabase JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #3a7d44; --text: #222; --bg: #e9f3eb; }
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Montserrat', sans-serif; }
        h1,h2,h3,button { font-family:'Poppins', sans-serif; }
        body { color:var(--text); padding-bottom:50px; background-color: #fcfcfc; }
        
        .container { max-width:1200px; margin:0 auto; padding:0 20px; }
        .hidden { display:none!important; }
        .btn { padding:12px 25px; border-radius:10px; border:none; font-weight:600; cursor:pointer; background:var(--primary); color:white; transition:0.3s cubic-bezier(0.25, 0.8, 0.25, 1); box-shadow: 0 4px 12px rgba(58, 125, 68, 0.3); }
        .btn:hover { transform:translateY(-2px); box-shadow: 0 8px 16px rgba(58, 125, 68, 0.4); }
        .btn:active { transform: scale(0.98); }

        /* --- NAVBAR --- */
        header { 
            position: fixed; top: 25px; left: 50%; transform: translateX(-50%); 
            width: auto; min-width: 650px; max-width: 95%; padding: 10px 20px; 
            background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(20px); 
            border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 15px 35px -10px rgba(0, 0, 0, 0.05); 
            border-radius: 100px; z-index: 1000; transition: all 0.4s;
        }
        header:hover { background: rgba(255, 255, 255, 0.95); transform: translateX(-50%) translateY(-2px); }
        .nav { display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.6rem; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 8px; padding-left: 10px; cursor: pointer; letter-spacing: -0.03em; }
        .nav-right { display: flex; align-items: center; gap: 15px; }
        .nav-links { display: flex; background: rgba(0,0,0,0.03); padding: 5px; border-radius: 30px; align-items: center; }
        .nav-links a { text-decoration: none; color: var(--text); font-weight: 500; font-size: 0.9rem; cursor: pointer; padding: 8px 18px; border-radius: 25px; transition: all 0.3s ease; display: inline-flex; align-items: center; height: 36px; }
        .nav-links a:hover, .nav-links a.active { color: var(--primary); background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .auth-btn { font-size: 0.85rem; font-weight: 600; cursor: pointer; color: white; background: var(--primary); padding: 0 24px; height: 46px; display: flex; align-items: center; border-radius: 30px; transition: 0.3s; text-decoration: none; }
        .auth-btn:hover { background: #235c42; }

        /* --- HERO --- */
        .hero { position: relative; padding: 180px 0 100px 0; text-align: center; overflow: hidden; }
        .hero h1 { font-size: 4.5rem; color: var(--primary); margin-bottom: 15px; line-height: 1.1; }
        .hero p { font-size: 1.2rem; color: #52796f; max-width: 500px; margin: 0 auto 30px; line-height: 1.6; }
        .grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(240px, 1fr)); gap:35px; }

        /* --- CARD --- */
        .card { width: 100%; height: 400px; background: #fff; border: 2px solid #323232; box-shadow: 4px 4px #323232; border-radius: 5px; display: flex; flex-direction: column; padding: 20px; gap: 10px; cursor: pointer; transition: transform 0.3s; }
        .card:hover { transform: translateY(-3px); }
        .card-img { display: flex; justify-content: center; height: 150px; overflow: hidden; border-radius: 4px; background: #f8f8f8; border: 1px solid #eee; }
        .card-img .img { width: 100%; height: 100%; object-fit: cover; mix-blend-mode: multiply; }
        .card-title { font-size: 18px; font-weight: 600; color: #323232; margin-top: 5px; line-height: 1.2; }
        .card-subtitle { font-size: 13px; font-weight: 400; color: #666; flex-grow: 1; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; }
        .card-divider { width: 100%; border: 1px solid #ddd; margin: 5px 0; }
        .card-footer { display: flex; justify-content: space-between; align-items: center; }
        .card-price { font-size: 20px; font-weight: 500; color: #323232; }
        .card-btn { height: 35px; width: 45px; background: #fff; border: 2px solid #323232; border-radius: 5px; display: flex; align-items: center; justify-content: center; transition: 0.3s; cursor: pointer; }
        .card-btn:hover { border: 2px solid #3a7d44; }
        .card-btn:hover svg { fill: #3a7d44; }
        .card-btn svg { width: 20px; height: 20px; fill: #323232; transition: 0.3s; }

        /* --- CART & MODALS --- */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 1500; opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(4px); }
        .overlay.open { opacity: 1; pointer-events: auto; }
        
        .cart-sidebar { position: fixed; top: 0; right: 0; width: 400px; height: 100%; background: white; z-index: 2000; box-shadow: -10px 0 50px rgba(0,0,0,0.1); transition: 0.4s; display: flex; flex-direction: column; transform: translateX(100%); }
        .cart-sidebar.open { transform: translateX(0); }
        .cart-header { padding: 30px; } .cart-items { flex: 1; overflow-y: auto; padding: 25px; } .cart-footer { padding: 30px; border-top: 1px solid #eee; background: #f9fafb; }
        .floating-cart { position: fixed; bottom: 30px; right: 30px; width: 70px; height: 70px; background: var(--primary); border-radius: 50%; box-shadow: 0 15px 40px rgba(45, 106, 79, 0.4); display: flex; justify-content: center; align-items: center; cursor: pointer; z-index: 900; transition: all 0.3s; }
        .floating-cart:hover { transform: scale(1.1) rotate(-5deg); }
        .cart-badge { position: absolute; top: 0; right: 0; background: #ffffff; color: var(--primary); font-weight: 800; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.2); border: 2px solid var(--primary); }

        .modal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:3000; display:flex; justify-content:center; align-items:center; opacity:0; pointer-events:none; transition:0.3s; backdrop-filter:blur(8px); }
        .modal.active { opacity:1; pointer-events:auto; }
        .modal-box { background: white; border-radius: 30px; max-width: 1000px; width: 95%; height: 85vh; display: flex; overflow: hidden; position: relative; }
        .detail-left { width: 50%; background: #f1f5f3; padding: 60px; display: flex; align-items: center; justify-content: center; }
        .detail-right { width: 50%; padding: 60px; overflow-y: auto; }
        .detail-left img { max-width: 100%; max-height: 100%; object-fit: contain; mix-blend-mode: multiply; }
        .close-btn { position: absolute; top: 25px; right: 25px; background: rgba(0,0,0,0.05); border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; z-index: 10; }
        .modal-stock-badge { display: inline-flex; align-items: center; padding: 6px 12px; background: #f0fdf4; color: var(--primary); border-radius: 20px; font-size: 0.85rem; font-weight: 600; margin-bottom: 20px; }
        .modal-stock-badge.low { background: #fef2f2; color: #ef4444; }
        .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: #323232; color: white; padding: 12px 30px; border-radius: 50px; opacity: 0; pointer-events: none; transition: 0.4s; z-index: 5000; font-weight: 600; display: flex; gap: 10px; }
        .toast.show { opacity: 1; bottom: 110px; pointer-events: auto; }
        
        /* ACCOUNT SIDEBAR */
        .account-sidebar { position: fixed; top: 0; left: 0; width: 420px; height: 100%; background: #fff; z-index: 2000; box-shadow: 10px 0 50px rgba(0,0,0,0.1); transition: 0.4s; display: flex; flex-direction: column; transform: translateX(-100%); }
        .account-sidebar.open { transform: translateX(0); }
        .ac-header { background: #3a7d44; color: white; padding: 40px 30px; }
        .ac-avatar-container { position: relative; width: 80px; height: 80px; margin-bottom: 10px; cursor: pointer; }
        .ac-avatar { width: 100%; height: 100%; border-radius: 50%; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-size: 2rem; border: 2px solid rgba(255,255,255,0.3); overflow: hidden; }
        .ac-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .ac-avatar-icon { position: absolute; bottom: 0; right: 0; background: white; color: #3a7d44; border-radius: 50%; padding: 4px; }
        .ac-stats { display: flex; gap: 15px; margin-top: 15px; }
        .ac-stat-card { background: rgba(255,255,255,0.15); padding: 15px; border-radius: 12px; flex: 1; }
        .ac-body { flex: 1; padding: 30px; background: #fcfcfc; }
        .ac-footer { padding: 30px; }
        .order-history-item { background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; border: 1px solid #eee; }

        @media(max-width:900px) { 
            header { min-width: auto; width: 95%; padding: 8px 15px; top: 15px; }
            .nav-links { display: none; } 
            .modal-box { flex-direction: column; height: 100%; border-radius: 0; }
            .detail-left, .detail-right { width: 100%; }
            .cart-sidebar, .account-sidebar { width: 100%; }
        }
    </style>
</head>
<body>

    <div id="toast" class="toast"><i data-lucide="check-circle" style="width:20px; color:#4ade80;"></i><span id="toastMsg">Added to cart</span></div>
    <div class="floating-cart" onclick="toggleCart()"><i data-lucide="shopping-cart" style="width:30px; height:30px; color: white;"></i><span id="cartCount" class="cart-badge">0</span></div>
    <div class="overlay" id="mainOverlay" onclick="closeAllSidebars()"></div>

    <!-- CART SIDEBAR -->
    <div class="cart-sidebar" id="cartSidebar">
        <div class="cart-header"><h3>Your Bag</h3><button class="close-btn" style="position:static;" onclick="toggleCart()"><i data-lucide="x"></i></button></div>
        <div class="cart-items" id="cartItemsContainer"></div>
        <div class="cart-footer">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px; font-weight:700; font-size:1.2rem;"><span>Total</span><span id="cartTotal">$0.00</span></div>
            <button class="btn" style="width:100%; padding: 18px; font-size:1.1rem;" onclick="initCheckout()">Checkout Now</button>
        </div>
    </div>

    <!-- ACCOUNT SIDEBAR -->
    <div class="account-sidebar" id="accountSidebar">
        <div class="ac-header">
            <input type="file" id="avatarInput" hidden accept="image/*" onchange="uploadAvatar(this)">
            <div class="ac-avatar-container" onclick="document.getElementById('avatarInput').click()">
                <div id="acAvatar" class="ac-avatar"><i data-lucide="user"></i></div>
                <div class="ac-avatar-icon"><i data-lucide="edit-2" style="width:12px; height:12px;"></i></div>
            </div>
            <h2 id="acName" style="font-size:1.5rem; margin:0;">Guest</h2>
            <p id="acEmail" style="font-size:0.9rem; opacity:0.8; margin:0;">Please login</p>
            <div class="ac-stats">
                <div class="ac-stat-card"><span class="ac-stat-val" style="font-weight:800; display:block;" id="totalSpent">$0.00</span><span style="font-size:0.7rem; text-transform:uppercase;">Spent</span></div>
                <div class="ac-stat-card"><span class="ac-stat-val" style="font-weight:800; display:block;" id="totalOrders">0</span><span style="font-size:0.7rem; text-transform:uppercase;">Orders</span></div>
            </div>
        </div>
        <div class="ac-body"><h3 style="font-weight:800; margin-bottom:20px;">Order History</h3><div id="orderHistoryList" style="color:#999; font-style:italic;">No orders found.</div></div>
        <div class="ac-footer"><button class="btn" style="width:100%; background:#ef4444;" onclick="logout()">Sign Out</button></div>
    </div>

    <!-- CHECKOUT MODAL -->
    <div id="checkoutModal" class="modal">
        <div class="modal-box" style="max-width:400px; height:auto; flex-direction:column; padding:30px;">
            <button class="close-btn" onclick="closeModal('checkoutModal')"><i data-lucide="x"></i></button>
            <h3 style="margin-bottom:20px; text-align:center;">Confirm Purchase</h3>
            <p style="margin-bottom:20px; text-align:center; color:#666;">Enter password to confirm order of <span id="checkoutTotalDisplay" style="font-weight:700; color:var(--primary);"></span>.</p>
            <input type="password" id="confirmPassword" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; margin-bottom:20px;" placeholder="Password">
            <button class="btn" style="width:100%;" onclick="processOrder()">Confirm & Pay</button>
        </div>
    </div>

    <!-- PRODUCT MODAL -->
    <div id="productModal" class="modal">
        <div class="modal-box">
            <button class="close-btn" onclick="closeModal('productModal')"><i data-lucide="x"></i></button>
            <div class="detail-left"><img id="dImg" src=""></div>
            <div class="detail-right">
                <h2 id="dName" style="font-size:2.8rem; line-height:1.1; margin-bottom:10px;">Product</h2>
                <div style="display:flex; align-items:center; gap:15px; margin-bottom:25px;">
                    <span id="dPrice" style="font-size:1.8rem; color:var(--primary); font-weight:700;">$0.00</span>
                    <span id="dStockBadge" class="modal-stock-badge">In Stock</span>
                </div>
                <p id="dDesc" style="font-size:1.1rem; line-height:1.7; color:#555; margin-bottom:30px;">Description</p>
                <button id="addBtn" class="btn" style="width:100%; padding:20px; font-size:1.1rem; display:flex; justify-content:center; gap:10px;" onclick="addToCart(curId)">Add to Cart <i data-lucide="arrow-right"></i></button>
                <div style="margin-top:50px; padding-top:30px; border-top:1px solid #eee;">
                    <h3 style="margin-bottom:20px;">Reviews</h3>
                    <div style="background:#f9f9f9; padding:20px; border-radius:15px; margin-bottom:20px;">
                        <input id="rName" style="width:100%; padding:12px; margin-bottom:10px; border:1px solid #ddd; border-radius:8px;" placeholder="Your Name">
                        <div class="star-widget" id="starWidget" style="font-size:1.5rem; color:#ccc; margin-bottom:10px; cursor:pointer;"><span onclick="rate(1)">★</span><span onclick="rate(2)">★</span><span onclick="rate(3)">★</span><span onclick="rate(4)">★</span><span onclick="rate(5)">★</span></div>
                        <textarea id="rText" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px;" placeholder="Write a review..." rows="3"></textarea>
                        <button class="btn" style="margin-top:10px; font-size:0.9rem; padding:10px 20px;" onclick="postReview()">Submit Review</button>
                    </div>
                    <div id="rList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- HEADER -->
    <header>
        <div class="nav">
            <div class="logo">flow <i data-lucide="leaf" style="color:var(--primary); fill:var(--primary-light);"></i></div>
            <div class="nav-right">
                <div class="nav-links">
                    <a href="Pages/about.html">About</a>
                    <a href="index.html" class="active">Shop</a>
                    <a href="Pages/collections.html">Collections</a>
                    <a href="Pages/journal.html">Journal</a>
                    <a href="Pages/contact.html">Contact</a>
                </div>
                <div id="authSection"></div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="hero">
            <h1>Mindful Living.</h1>
            <p>Thoughtfully curated essentials for a sustainable home.</p>
        </div>
        <div id="loader" style="text-align:center; padding:40px; color:#999;">Loading...</div>
        <div id="grid" class="grid"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://rbjxpbogrjlfdqpirbyj.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJianhwYm9ncmpsZmRxcGlyYnlqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3MDU1OTksImV4cCI6MjA4MDI4MTU5OX0.0dEtjUKYBMO2m-JwSAvwTA-9kZB7e6asrhTULlHevjs';
        let sb = null, products = [], curId = null, curRating = 0, cart = JSON.parse(localStorage.getItem('flow_cart')) || [], user = null;

        window.onload = async () => {
            lucide.createIcons();
            sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            const { data } = await sb.auth.getUser();
            user = data.user;
            
            updateAuthUI();
            fetchProducts();
            updateCartUI(); 
            if(user) loadAccountStats();
        };

        function showToast(msg) { const t = document.getElementById('toast'); document.getElementById('toastMsg').innerText = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); }
        
        function updateAuthUI() {
            const s = document.getElementById('authSection');
            // FIXED: Point to sibling login.html
            if (user) s.innerHTML = `<span class="auth-btn" onclick="toggleAccount()">Profile</span>`;
            else s.innerHTML = `<a href="login.html" class="auth-btn">Sign In</a>`;
        }

        async function logout() { await sb.auth.signOut(); window.location.reload(); }
        function closeAllSidebars() { document.getElementById('cartSidebar').classList.remove('open'); document.getElementById('accountSidebar').classList.remove('open'); document.getElementById('checkoutModal').classList.remove('active'); document.getElementById('mainOverlay').classList.remove('open'); }
        function toggleCart() { closeAllSidebars(); document.getElementById('cartSidebar').classList.add('open'); document.getElementById('mainOverlay').classList.add('open'); }
        function toggleAccount() { closeAllSidebars(); document.getElementById('accountSidebar').classList.add('open'); document.getElementById('mainOverlay').classList.add('open'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); if(id === 'checkoutModal') closeAllSidebars(); else document.getElementById('mainOverlay').classList.remove('open'); }

        async function fetchProducts() {
            const { data, error } = await sb.from('products').select('*').order('id');
            document.getElementById('loader').classList.add('hidden');
            if(!error) {
                products = data;
                const grid = document.getElementById('grid');
                grid.innerHTML = '';
                data.forEach(p => {
                    const desc = p.description || "Premium sustainable product.";
                    grid.innerHTML += `
                    <div class="card" onclick="openProduct(${p.id})">
                        <div class="card-img"><img src="${p.image_url}" class="img" alt="${p.name}"></div>
                        <div class="card-title">${p.name}</div>
                        <div class="card-subtitle">${desc}</div>
                        <hr class="card-divider">
                        <div class="card-footer">
                            <div class="card-price">$${p.price}</div>
                            <button class="card-btn" onclick="event.stopPropagation(); addToCart(${p.id})"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="m397.78 316h-205.13a15 15 0 0 1 -14.65-11.67l-34.54-150.48a15 15 0 0 1 14.62-18.36h274.27a15 15 0 0 1 14.65 18.36l-34.6 150.48a15 15 0 0 1 -14.62 11.67zm-193.19-30h181.25l27.67-120.48h-236.6z"></path><path d="m222 450a57.48 57.48 0 1 1 57.48-57.48 57.54 57.54 0 0 1 -57.48 57.48zm0-84.95a27.48 27.48 0 1 0 27.48 27.47 27.5 27.5 0 0 0 -27.48-27.47z"></path><path d="m368.42 450a57.48 57.48 0 1 1 57.48-57.48 57.54 57.54 0 0 1 -57.48 57.48zm0-84.95a27.48 27.48 0 1 0 27.48 27.47 27.5 27.5 0 0 0 -27.48-27.47z"></path><path d="m158.08 165.49a15 15 0 0 1 -14.23-10.26l-25.71-77.23h-47.44a15 15 0 1 1 0-30h58.3a15 15 0 0 1 14.23 10.26l29.13 87.49a15 15 0 0 1 -14.23 19.74z"></path></svg></button>
                        </div>
                    </div>`;
                });
            }
        }

        async function openProduct(id) {
            curId = id;
            const p = products.find(x => x.id === id);
            document.getElementById('dImg').src = p.image_url;
            document.getElementById('dName').innerText = p.name;
            document.getElementById('dPrice').innerText = '$' + p.price;
            document.getElementById('dDesc').innerText = p.description || "No description.";
            
            const badge = document.getElementById('dStockBadge');
            const addBtn = document.getElementById('addBtn');
            if(p.stock > 0) {
                badge.innerText = "In Stock"; badge.className = "modal-stock-badge";
                addBtn.disabled = false; addBtn.style.opacity = "1"; addBtn.style.cursor = "pointer";
            } else {
                badge.innerText = "Out of Stock"; badge.className = "modal-stock-badge low";
                addBtn.disabled = true; addBtn.style.opacity = "0.5"; addBtn.style.cursor = "not-allowed";
            }
            
            document.getElementById('productModal').classList.add('active');
            rate(0); document.getElementById('rName').value=''; document.getElementById('rText').value='';
            loadReviews(id);
        }

        async function loadAccountStats() {
            const { data: profile } = await sb.from('profiles').select('username, avatar_url').eq('id', user.id).single();
            const username = profile ? profile.username : user.email.split('@')[0];
            
            document.getElementById('acName').innerText = username;
            document.getElementById('acEmail').innerText = user.email;

            // Set Avatar if exists
            const avatarEl = document.getElementById('acAvatar');
            if (profile && profile.avatar_url) {
                avatarEl.innerHTML = `<img src="${profile.avatar_url}" style="width:100%; height:100%; object-fit:cover; border-radius:50%;">`;
                avatarEl.style.backgroundColor = 'transparent';
                avatarEl.style.border = '2px solid white';
            }

            const { data: orders } = await sb.from('orders').select('*').eq('user_id', user.id).order('created_at', {ascending: false});
            if (orders) {
                const total = orders.reduce((a, b) => a + b.total_amount, 0);
                document.getElementById('totalSpent').innerText = '$' + total.toFixed(2);
                document.getElementById('totalOrders').innerText = orders.length;
                const list = document.getElementById('orderHistoryList');
                if (orders.length > 0) {
                    list.innerHTML = '';
                    orders.forEach(o => {
                        list.innerHTML += `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px dashed #eee; margin-bottom:10px;"><span>#${o.id} <small style="color:#999;">${new Date(o.created_at).toLocaleDateString()}</small></span><strong>$${o.total_amount.toFixed(2)}</strong></div>`;
                    });
                }
            }
        }

        // --- AVATAR UPLOAD ---
        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        async function uploadAvatar(input) {
            if (input.files && input.files[0]) {
                try {
                    const base64Img = await toBase64(input.files[0]);
                    const { error } = await sb.from('profiles').update({ avatar_url: base64Img }).eq('id', user.id);
                    if (error) throw error;
                    
                    const avatarEl = document.getElementById('acAvatar');
                    avatarEl.innerHTML = `<img src="${base64Img}" style="width:100%; height:100%; object-fit:cover; border-radius:50%;">`;
                    avatarEl.style.backgroundColor = 'transparent';
                    avatarEl.style.border = '2px solid white';
                    
                    showToast("Profile updated");
                } catch (e) { alert(e.message); }
            }
        }

        function addToCart(id) {
            if (!user) { if(confirm("Please login.")) window.location.href = 'login.html'; return; }
            const p = products.find(x => x.id === id);
            const ex = cart.find(x => x.id === id);
            if((ex?.qty || 0) + 1 > p.stock) return alert("Out of stock");
            if(ex) ex.qty++; else cart.push({ ...p, qty: 1 });
            saveCart(); updateCartUI(); showToast("Added to cart");
        }

        function removeFromCart(id) { cart = cart.filter(x => x.id !== id); saveCart(); updateCartUI(); }
        function saveCart() { localStorage.setItem('flow_cart', JSON.stringify(cart)); }
        function updateCartUI() {
            const count = cart.reduce((a, b) => a + b.qty, 0);
            document.getElementById('cartCount').innerText = count;
            const con = document.getElementById('cartItemsContainer');
            con.innerHTML = '';
            let total = 0;
            if(cart.length === 0) con.innerHTML = '<div style="text-align:center; color:#999; margin-top:50px;">Your bag is empty</div>';
            cart.forEach(item => {
                total += item.price * item.qty;
                con.innerHTML += `<div class="cart-item" style="display:flex; gap:15px; margin-bottom:15px; align-items:center;"><img src="${item.image_url}" style="width:60px; height:60px; object-fit:cover; border-radius:8px;"><div><div style="font-weight:600;">${item.name}</div><div>$${item.price} x ${item.qty}</div></div><button onclick="removeFromCart(${item.id})" style="margin-left:auto; border:none; background:none; color:red; cursor:pointer;"><i data-lucide="trash-2" style="width:18px;"></i></button></div>`;
            });
            lucide.createIcons();
            document.getElementById('cartTotal').innerText = '$' + total.toFixed(2);
        }
        function updateQty(id, ch) {
            const it = cart.find(x => x.id === id); const p = products.find(x => x.id === id);
            if(it) { if(ch > 0 && it.qty >= p.stock) return alert("Max stock reached"); it.qty += ch; if(it.qty <= 0) removeFromCart(id); else { saveCart(); updateCartUI(); } }
        }

        function initCheckout() {
            if(cart.length === 0) return alert("Cart empty");
            if(!user) { window.location.href = 'login.html'; return; }
            document.getElementById('checkoutTotalDisplay').innerText = document.getElementById('cartTotal').innerText;
            closeAllSidebars();
            document.getElementById('checkoutModal').classList.add('active');
            document.getElementById('mainOverlay').classList.add('open');
        }

        async function processOrder() {
            const pw = document.getElementById('confirmPassword').value;
            if(!pw) return alert("Password required");
            const { error } = await sb.auth.signInWithPassword({ email: user.email, password: pw });
            if(error) return alert("Wrong password");

            const total = cart.reduce((a, c) => a + c.price * c.qty, 0);
            const { data: profile } = await sb.from('profiles').select('username').eq('id', user.id).single();
            const { data: order } = await sb.from('orders').insert([{ customer_name: profile.username, total_amount: total, user_id: user.id }]).select().single();
            
            for (const item of cart) {
                await sb.from('order_items').insert([{ order_id: order.id, product_id: item.id, quantity: item.qty, price: item.price }]);
                const p = products.find(x => x.id === item.id);
                await sb.from('products').update({ stock: p.stock - item.qty }).eq('id', item.id);
            }
            alert("Order Success!"); cart = []; saveCart(); updateCartUI(); closeAllSidebars(); fetchProducts(); loadAccountStats();
        }

        function rate(n) { curRating = n; Array.from(document.getElementById('starWidget').children).forEach((s,i) => s.style.color = i < n ? '#facc15' : '#ccc'); }
        async function loadReviews(pid) {
            const list = document.getElementById('rList'); list.innerHTML = 'Loading...';
            const { data } = await sb.from('reviews').select('*').eq('product_id', pid).order('created_at',{ascending:false});
            list.innerHTML = '';
            if(data && data.length > 0) data.forEach(r => list.innerHTML += `<div style="padding:15px 0; border-bottom:1px solid #eee;"><strong>${r.user_name}</strong> <span style="color:#facc15;">${'★'.repeat(r.rating)}</span><p style="color:#666;">${r.comment}</p></div>`);
            else list.innerHTML = '<p style="color:#999;">No reviews yet.</p>';
        }
        async function postReview() {
            if(!user) return alert("Login required");
            const name = document.getElementById('rName').value; const txt = document.getElementById('rText').value;
            if(!name || curRating === 0) return alert("Details required");
            const { data: orders } = await sb.from('orders').select('id').eq('user_id', user.id);
            if(!orders || orders.length === 0) return alert("Purchase required");
            const oIds = orders.map(o => o.id);
            const { data: items } = await sb.from('order_items').select('id').in('order_id', oIds).eq('product_id', curId);
            if(!items || items.length === 0) return alert("You must buy this item first.");
            await sb.from('reviews').insert([{product_id: curId, user_name: name, rating: curRating, comment: txt}]);
            loadReviews(curId);
        }
    </script>
</body>
</html>