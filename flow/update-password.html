<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flow | Update Password</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #2d6a4f; --text: #1b4332; --bg: #f8faf9; }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family: 'Outfit', sans-serif; height: 100vh; display: flex; background: var(--bg); overflow: hidden; }
        .split-screen { display: flex; width: 100%; height: 100%; }
        .left-panel { flex: 1; background: url('https://images.unsplash.com/photo-1542601906990-b4d3fb778b09?q=80&w=2500&auto=format&fit=crop') center/cover no-repeat; position: relative; display: flex; flex-direction: column; justify-content: space-between; padding: 40px; color: white; }
        .left-panel::after { content: ''; position: absolute; top:0; left:0; width:100%; height:100%; background: linear-gradient(to bottom, rgba(45, 106, 79, 0.3), rgba(27, 67, 50, 0.7)); z-index: 1; }
        .brand-content { position: relative; z-index: 2; }
        .brand-logo { font-family: 'Playfair Display', serif; font-size: 2.5rem; font-weight: 700; display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .right-panel { flex: 1; max-width: 600px; background: white; display: flex; align-items: center; justify-content: center; padding: 40px; position: relative; box-shadow: -10px 0 30px rgba(0,0,0,0.05); }
        .auth-container { width: 100%; max-width: 380px; }
        h2 { font-family: 'Playfair Display', serif; font-size: 2.5rem; color: var(--primary); margin-bottom: 10px; }
        .subtitle { color: #666; margin-bottom: 40px; font-size: 1rem; }
        .input-group { margin-bottom: 20px; }
        .input { width: 100%; padding: 14px 16px; border: 1px solid #e0e0e0; border-radius: 12px; font-family: inherit; font-size: 1rem; background: #f9f9f9; display: block; }
        .btn { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 50px; font-weight: 600; cursor: pointer; margin-top: 10px; box-shadow: 0 4px 15px rgba(45, 106, 79, 0.2); }
        .back-link { position: absolute; top: 40px; right: 40px; text-decoration: none; color: #888; font-weight: 600; font-size: 0.9rem; display: flex; align-items: center; gap: 5px; }
        @media (max-width: 900px) { .left-panel { display: none; } .right-panel { max-width: 100%; } }
    </style>
</head>
<body>
    <div class="split-screen">
        <div class="left-panel">
            <div class="brand-content"><div class="brand-logo">flow <i data-lucide="leaf"></i></div></div>
            <div class="brand-content"><p style="font-size:1.5rem; font-weight:300;">"Secure your account to continue your sustainable journey."</p></div>
        </div>
        <div class="right-panel">
            <!-- FIXED LINK -->
            <a href="login.html" class="back-link"><i data-lucide="arrow-left" style="width:16px;"></i> Back to Login</a>
            <div class="auth-container">
                <h2 id="headingTitle">Set New Password</h2>
                <p class="subtitle" id="subTitle">Enter your new secure password below.</p>

                <div id="errorBox" style="color:#ef4444; margin-bottom:20px; display:none; background:#fef2f2; padding:10px; border-radius:8px;"></div>
                <div id="successBox" style="color:#16a34a; margin-bottom:20px; display:none; background:#f0fdf4; padding:10px; border-radius:8px;">Password updated! Redirecting...</div>

                <form id="updateForm">
                    <div class="input-group">
                        <label style="font-weight:600; font-size:0.85rem; display:block; margin-bottom:8px;">New Password</label>
                        <input type="password" id="newPassword" class="input" placeholder="••••••••" required>
                    </div>
                    <div class="input-group">
                        <label style="font-weight:600; font-size:0.85rem; display:block; margin-bottom:8px;">Confirm Password</label>
                        <input type="password" id="confirmPassword" class="input" placeholder="••••••••" required>
                    </div>
                    
                    <button type="submit" class="btn" id="submitBtn">Update Password</button>
                </form>
            </div>
        </div>
    </div>
    <script>
        lucide.createIcons();
        const sb = window.supabase.createClient('https://rbjxpbogrjlfdqpirbyj.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJianhwYm9ncmpsZmRxcGlyYnlqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3MDU1OTksImV4cCI6MjA4MDI4MTU5OX0.0dEtjUKYBMO2m-JwSAvwTA-9kZB7e6asrhTULlHevjs');

        sb.auth.onAuthStateChange(async (event, session) => {
            if (event === 'PASSWORD_RECOVERY') {
                console.log("Recovery session active");
            }
        });

        document.getElementById('updateForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const p1 = document.getElementById('newPassword').value;
            const p2 = document.getElementById('confirmPassword').value;
            const err = document.getElementById('errorBox');
            const succ = document.getElementById('successBox');
            const btn = document.getElementById('submitBtn');

            err.style.display = 'none';
            succ.style.display = 'none';

            if (p1 !== p2) {
                err.innerText = "Passwords do not match.";
                err.style.display = 'block';
                return;
            }

            btn.disabled = true;
            btn.innerText = "Updating...";

            try {
                const { error } = await sb.auth.updateUser({ password: p1 });
                if (error) throw error;
                succ.style.display = 'block';
                setTimeout(() => {
                    // FIXED: Sibling path
                    window.location.href = 'index.html';
                }, 2000);
            } catch (error) {
                err.innerText = error.message;
                err.style.display = 'block';
                btn.disabled = false;
                btn.innerText = "Update Password";
            }
        });
    </script>
</body>
</html>