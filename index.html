<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flow | Sustainable Living (Supabase Edition)</title>
    
    <!-- SUPABASE JS LIBRARY (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- FONTS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600&family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">

    <!-- ICONS -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* --- CSS VARIABLES & RESET --- */
        :root {
            --primary: #3a7d44;
            --primary-dark: #2c5e34;
            --bg-light: #e9f3eb;
            --text-dark: #222;
            --text-light: #666;
            --white: #fff;
            --font-head: 'Poppins', sans-serif;
            --font-body: 'Montserrat', sans-serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-body); color: var(--text-dark); background: var(--white); overflow-x: hidden; }
        h1, h2, h3, button, .logo { font-family: var(--font-head); }
        
        /* --- UTILS --- */
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .btn { padding: 12px 30px; border-radius: 50px; border: none; font-weight: 700; cursor: pointer; transition: 0.3s; }
        .btn-primary { background: var(--primary); color: var(--white); }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-2px); }
        .hidden { display: none !important; }

        /* --- HEADER --- */
        header { padding: 20px 0; position: sticky; top: 0; background: rgba(255,255,255,0.95); backdrop-filter: blur(5px); z-index: 50; border-bottom: 1px solid #eee; }
        .nav-flex { display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.8rem; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .nav-links { display: flex; gap: 30px; list-style: none; }
        .nav-links a { text-decoration: none; color: var(--text-dark); font-weight: 600; font-size: 0.9rem; cursor: pointer; }
        .nav-links a:hover { color: var(--primary); }
        .icon-btn { background: none; border: none; cursor: pointer; position: relative; }
        .badge { position: absolute; top: -5px; right: -5px; background: var(--primary); color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; }

        /* --- HERO --- */
        .hero { background: var(--bg-light); padding: 80px 0; border-radius: 0 0 30px 30px; }
        .hero-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 50px; align-items: center; }
        .hero h1 { font-size: 3.5rem; line-height: 1.1; color: var(--primary); margin-bottom: 20px; }
        .hero p { font-size: 1.1rem; color: var(--text-light); margin-bottom: 30px; max-width: 450px; }
        .hero-img { width: 100%; height: 400px; object-fit: cover; border-radius: 20px; box-shadow: 0 20px 40px rgba(58,125,68,0.15); }

        /* --- PRODUCTS --- */
        .products { padding: 80px 0; }
        .section-title { text-align: center; font-size: 2.5rem; margin-bottom: 50px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 30px; }
        
        .card { border: 1px solid #eee; border-radius: 15px; padding: 15px; transition: 0.3s; background: white; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.05); border-color: transparent; }
        .card-img { width: 100%; height: 250px; object-fit: cover; border-radius: 10px; background: #f9f9f9; }
        .card-info { padding-top: 15px; }
        .card-title { font-weight: 700; margin-bottom: 5px; font-size: 1.1rem; }
        .card-price { color: var(--primary); font-weight: 700; font-size: 1.1rem; display: block; margin-bottom: 10px; }
        .btn-full { width: 100%; padding: 10px; border-radius: 10px; background: var(--bg-light); color: var(--primary); }
        .btn-full:hover { background: var(--primary); color: white; }

        /* --- ADMIN PANEL --- */
        .admin-panel { padding: 60px 0; max-width: 800px; margin: 0 auto; }
        .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; }
        .form-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-family: inherit; }
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 30px; }
        .admin-table th { text-align: left; padding: 15px; background: #f5f5f5; font-size: 0.9rem; }
        .admin-table td { padding: 15px; border-bottom: 1px solid #eee; }
        .btn-delete { color: #e74c3c; background: none; border: none; cursor: pointer; font-weight: 600; }

        /* --- CART SIDEBAR --- */
        .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 99; opacity: 0; pointer-events: none; transition: 0.3s; }
        .sidebar { position: fixed; top: 0; right: -400px; width: 400px; height: 100%; background: white; z-index: 100; transition: 0.3s cubic-bezier(0.16, 1, 0.3, 1); display: flex; flex-direction: column; }
        .sidebar.active { right: 0; }
        .sidebar-overlay.active { opacity: 1; pointer-events: auto; }
        .cart-header { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .cart-items { flex: 1; overflow-y: auto; padding: 20px; }
        .cart-footer { padding: 20px; background: #f9f9f9; border-top: 1px solid #eee; }
        .cart-item { display: flex; gap: 15px; margin-bottom: 20px; }
        .cart-item img { width: 70px; height: 70px; object-fit: cover; border-radius: 8px; }

        /* --- CONFIG MODAL --- */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 200; display: flex; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 40px; border-radius: 20px; width: 90%; max-width: 500px; text-align: center; }
        .input-group { margin: 20px 0; text-align: left; }
        .status-dot { width: 10px; height: 10px; background: #ddd; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-dot.connected { background: #2ecc71; }

        @media (max-width: 768px) {
            .hero-grid { grid-template-columns: 1fr; text-align: center; }
            .sidebar { width: 100%; }
        }
    </style>
</head>
<body>

    <!-- CONFIGURATION MODAL (Shown if no keys) -->
    <div id="configModal" class="modal hidden">
        <div class="modal-content">
            <h2 style="color: var(--primary);">Setup Supabase âš¡</h2>
            <p style="margin-top: 10px; color: #666; font-size: 0.9rem;">
                To make this Database work, create a project at <b>supabase.com</b> and paste your credentials below.
            </p>
            <div class="input-group">
                <label>Project URL</label>
                <input type="text" id="supabaseUrl" class="form-input" placeholder="https://xyz.supabase.co">
            </div>
            <div class="input-group">
                <label>Anon Public Key</label>
                <input type="text" id="supabaseKey" class="form-input" placeholder="eyJhbGciOiJIUzI1...">
            </div>
            <button onclick="saveConfig()" class="btn btn-primary" style="width: 100%;">Connect Database</button>
            <p style="margin-top: 15px; font-size: 0.8rem; color: #999;">
                Create table 'products' (id, name, price, image_url)
            </p>
        </div>
    </div>

    <!-- HEADER -->
    <header>
        <div class="container nav-flex">
            <div class="logo" onclick="switchView('shop')">
                flow <i data-lucide="leaf"></i>
            </div>
            <nav>
                <ul class="nav-links">
                    <li><a onclick="switchView('shop')">Shop</a></li>
                    <li><a onclick="toggleAdmin()">Admin</a></li>
                    <li>
                        <button class="icon-btn" onclick="toggleCart()">
                            <i data-lucide="shopping-bag"></i>
                            <span class="badge" id="cartCount">0</span>
                        </button>
                    </li>
                    <li id="dbStatus" title="DB Connection Status" style="display: flex; align-items: center;">
                        <span class="status-dot" id="statusDot"></span>
                    </li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- SHOP VIEW -->
    <div id="shopView">
        <section class="hero">
            <div class="container hero-grid">
                <div>
                    <h1>Discover <br> Sustainable Living</h1>
                    <p>Curated eco-friendly products for a balanced, mindful lifestyle. Connected to real data.</p>
                    <button class="btn btn-primary" onclick="scrollToProducts()">Explore Collection</button>
                </div>
                <img src="https://images.unsplash.com/photo-1520302665673-890422463439?ixlib=rb-4.0.3&w=800&q=80" class="hero-img" alt="Hero">
            </div>
        </section>

        <section class="products container" id="productsSection">
            <h2 class="section-title">New Arrivals</h2>
            <div id="loading" style="text-align: center; color: #999;">Loading products from Supabase...</div>
            <div class="grid" id="productGrid">
                <!-- Products injected here -->
            </div>
        </section>
    </div>

    <!-- ADMIN VIEW -->
    <div id="adminView" class="container admin-panel hidden">
        <div class="admin-header">
            <h2>Admin Dashboard</h2>
            <button onclick="switchView('shop')" class="btn" style="border: 1px solid #ddd;">Exit Admin</button>
        </div>

        <!-- Admin Login (Simple) -->
        <div id="adminLogin">
            <h3>Enter Admin Password</h3>
            <div class="form-group" style="margin-top: 15px;">
                <input type="password" id="adminPass" class="form-input" placeholder="Password (admin123)">
            </div>
            <button onclick="checkAdmin()" class="btn btn-primary">Login</button>
        </div>

        <!-- Admin Content (Protected) -->
        <div id="adminContent" class="hidden">
            <div style="background: #f9f9f9; padding: 25px; border-radius: 15px;">
                <h3 style="margin-bottom: 20px;">Add New Product</h3>
                <div class="form-group">
                    <label>Product Name</label>
                    <input type="text" id="newName" class="form-input">
                </div>
                <div class="form-group">
                    <label>Price ($)</label>
                    <input type="number" id="newPrice" class="form-input">
                </div>
                <div class="form-group">
                    <label>Image URL</label>
                    <input type="text" id="newImage" class="form-input" placeholder="https://...">
                </div>
                <button onclick="addProduct()" class="btn btn-primary">Add Product to DB</button>
            </div>

            <h3 style="margin-top: 40px;">Current Inventory</h3>
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Image</th>
                        <th>Name</th>
                        <th>Price</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="adminTableBody">
                    <!-- Rows -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- CART SIDEBAR -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleCart()"></div>
    <div class="sidebar" id="sidebar">
        <div class="cart-header">
            <h3>Your Cart</h3>
            <button onclick="toggleCart()" style="background:none; border:none; font-size: 1.5rem; cursor:pointer;">&times;</button>
        </div>
        <div class="cart-items" id="cartItems">
            <!-- Cart Items -->
        </div>
        <div class="cart-footer">
            <div style="display: flex; justify-content: space-between; font-weight: 700; font-size: 1.2rem; margin-bottom: 20px;">
                <span>Total</span>
                <span id="cartTotal">$0.00</span>
            </div>
            <button class="btn btn-primary" style="width: 100%;">Checkout</button>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- STATE & CONFIG ---
        let supabase = null;
        let cart = [];
        let products = [];
        
        // --- INIT ---
        window.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            
            // Check for saved keys
            const url = localStorage.getItem('supabase_url');
            const key = localStorage.getItem('supabase_key');
            
            if (url && key) {
                initSupabase(url, key);
            } else {
                document.getElementById('configModal').classList.remove('hidden');
            }
        });

        // --- SUPABASE SETUP ---
        function saveConfig() {
            const url = document.getElementById('supabaseUrl').value;
            const key = document.getElementById('supabaseKey').value;
            
            if(!url || !key) return alert("Please enter both URL and Key");
            
            localStorage.setItem('supabase_url', url);
            localStorage.setItem('supabase_key', key);
            
            initSupabase(url, key);
            document.getElementById('configModal').classList.add('hidden');
        }

        function initSupabase(url, key) {
            try {
                supabase = window.supabase.createClient(url, key);
                document.getElementById('statusDot').classList.add('connected');
                fetchProducts();
            } catch (err) {
                console.error("Supabase Init Error", err);
                alert("Invalid Supabase Config");
            }
        }

        // --- DATA FETCHING ---
        async function fetchProducts() {
            if (!supabase) return;
            
            document.getElementById('loading').style.display = 'block';
            
            // Select from 'products' table
            const { data, error } = await supabase
                .from('products')
                .select('*')
                .order('created_at', { ascending: false });

            document.getElementById('loading').style.display = 'none';

            if (error) {
                console.error(error);
                document.getElementById('productGrid').innerHTML = `<p style="color:red">Error: ${error.message}. <br>Make sure table 'products' exists and RLS is off.</p>`;
            } else {
                products = data || [];
                renderShop();
                renderAdminTable();
            }
        }

        async function addProduct() {
            const name = document.getElementById('newName').value;
            const price = parseFloat(document.getElementById('newPrice').value);
            const image_url = document.getElementById('newImage').value;

            if (!name || !price) return alert("Please fill details");

            const { data, error } = await supabase
                .from('products')
                .insert([{ name, price, image_url }])
                .select();

            if (error) {
                alert("Error adding: " + error.message);
            } else {
                // Clear form
                document.getElementById('newName').value = '';
                document.getElementById('newPrice').value = '';
                document.getElementById('newImage').value = '';
                
                // Refresh
                fetchProducts();
                alert("Product Added!");
            }
        }

        async function deleteProduct(id) {
            if(!confirm("Delete this item?")) return;

            const { error } = await supabase
                .from('products')
                .delete()
                .eq('id', id);

            if (error) alert("Error deleting: " + error.message);
            else fetchProducts();
        }

        // --- UI RENDERING ---
        function renderShop() {
            const grid = document.getElementById('productGrid');
            grid.innerHTML = '';
            
            if(products.length === 0) {
                grid.innerHTML = '<p>No products in database yet. Go to Admin to add some.</p>';
                return;
            }

            products.forEach(p => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <img src="${p.image_url || 'https://via.placeholder.com/300'}" class="card-img" alt="${p.name}">
                    <div class="card-info">
                        <div class="card-title">${p.name}</div>
                        <span class="card-price">$${p.price.toFixed(2)}</span>
                        <button class="btn btn-full" onclick="addToCart(${p.id})">Add to Cart</button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function renderAdminTable() {
            const tbody = document.getElementById('adminTableBody');
            tbody.innerHTML = '';

            products.forEach(p => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><img src="${p.image_url}" style="width:40px; height:40px; border-radius:4px; object-fit:cover;"></td>
                    <td>${p.name}</td>
                    <td>$${p.price}</td>
                    <td><button class="btn-delete" onclick="deleteProduct(${p.id})">Delete</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- CART LOGIC ---
        function addToCart(id) {
            const product = products.find(p => p.id === id);
            const existing = cart.find(item => item.id === id);
            
            if(existing) existing.qty++;
            else cart.push({ ...product, qty: 1 });
            
            updateCartUI();
            toggleCart(true); // Open cart
        }

        function updateCartUI() {
            const itemsDiv = document.getElementById('cartItems');
            itemsDiv.innerHTML = '';
            let total = 0;
            let count = 0;

            cart.forEach(item => {
                total += item.price * item.qty;
                count += item.qty;
                
                itemsDiv.innerHTML += `
                    <div class="cart-item">
                        <img src="${item.image_url}" alt="img">
                        <div style="flex:1">
                            <div style="font-weight:600">${item.name}</div>
                            <div style="color:var(--primary)">$${item.price} x ${item.qty}</div>
                        </div>
                    </div>
                `;
            });

            document.getElementById('cartTotal').innerText = '$' + total.toFixed(2);
            document.getElementById('cartCount').innerText = count;
        }

        // --- NAVIGATION ---
        function toggleCart(forceOpen = false) {
            const sb = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            if(forceOpen || !sb.classList.contains('active')) {
                sb.classList.add('active');
                overlay.classList.add('active');
            } else {
                sb.classList.remove('active');
                overlay.classList.remove('active');
            }
        }

        function switchView(viewName) {
            if(viewName === 'shop') {
                document.getElementById('shopView').classList.remove('hidden');
                document.getElementById('adminView').classList.add('hidden');
            } else {
                document.getElementById('shopView').classList.add('hidden');
                document.getElementById('adminView').classList.remove('hidden');
            }
        }

        function toggleAdmin() {
            switchView('admin');
        }

        function checkAdmin() {
            const pass = document.getElementById('adminPass').value;
            if(pass === 'admin123') {
                document.getElementById('adminLogin').classList.add('hidden');
                document.getElementById('adminContent').classList.remove('hidden');
                // Auto seed prompt if empty
                if(products.length === 0) {
                   if(confirm("Database is empty. Want to add example data?")) seedData();
                }
            } else {
                alert("Wrong password");
            }
        }

        // Helper to quick start
        async function seedData() {
            const seeds = [
                { name: "Matte Reusable Bottle", price: 24.00, image_url: "https://images.unsplash.com/photo-1602143407151-01114192003f?w=500" },
                { name: "Organic Cotton Tote", price: 18.00, image_url: "https://images.unsplash.com/photo-1597484661643-2f5fef640dd1?w=500" },
                { name: "Potted Echeveria", price: 22.00, image_url: "https://images.unsplash.com/photo-1485955900006-10f4d324d411?w=500" }
            ];
            
            for(let s of seeds) {
                await supabase.from('products').insert([s]);
            }
            fetchProducts();
        }

        function scrollToProducts() {
            document.getElementById('productsSection').scrollIntoView({behavior: 'smooth'});
        }
    </script>
</body>
</html>