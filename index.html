<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flow | Shop</title>
    <!-- Supabase JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600&family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #3a7d44; --text: #222; --bg: #e9f3eb; }
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Montserrat', sans-serif; }
        h1,h2,h3,button { font-family:'Poppins', sans-serif; }
        body { color:var(--text); padding-bottom:50px; background-color: #fcfcfc; }
        
        .container { max-width:1200px; margin:0 auto; padding:0 20px; }
        .hidden { display:none!important; }
        .btn { padding:12px 25px; border-radius:10px; border:none; font-weight:600; cursor:pointer; background:var(--primary); color:white; transition:0.3s cubic-bezier(0.25, 0.8, 0.25, 1); box-shadow: 0 4px 12px rgba(58, 125, 68, 0.3); }
        .btn:hover { transform:translateY(-2px); box-shadow: 0 8px 16px rgba(58, 125, 68, 0.4); }
        .btn:active { transform: scale(0.98); }

        header { padding:20px 0; position:sticky; top:0; background:rgba(255,255,255,0.95); z-index:50; border-bottom:1px solid #eee; backdrop-filter: blur(10px); }
        .nav { display:flex; justify-content:space-between; align-items:center; }
        .logo { font-size:1.5rem; font-weight:800; color:var(--primary); display:flex; gap:5px; }
        .nav-links { display: flex; gap: 20px; align-items: center; }
        .nav-links a { text-decoration:none; color:var(--text); font-weight:600; font-size:0.9rem; cursor: pointer; position: relative; }
        
        .hero { background:var(--bg); padding:100px 0; border-radius:0 0 40px 40px; margin-bottom:60px; text-align:center; }
        .hero h1 { font-size:3.5rem; color:var(--primary); margin-bottom:15px; letter-spacing: -1px; }
        .hero p { font-size: 1.1rem; color: #666; max-width: 600px; margin: 0 auto; }

        .grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(240px, 1fr)); gap:40px; }

        /* --- CARD DESIGN --- */
        .card {
            --font-color: #323232;
            --font-color-sub: #666;
            --bg-color: #fff;
            --main-color: #323232;
            --main-focus: #3a7d44;
            width: 100%;
            height: 400px;
            background: var(--bg-color);
            border: 2px solid var(--main-color);
            box-shadow: 4px 4px var(--main-color);
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            padding: 20px;
            gap: 10px;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover { transform: translateY(-4px); box-shadow: 6px 6px var(--main-color); }

        .card-img {
            transition: all 0.5s;
            display: flex;
            justify-content: center;
            height: 150px;
            overflow: hidden;
            border-radius: 4px;
            background: #f8f8f8;
        }

        .card-img .img { width: 100%; height: 100%; object-fit: cover; mix-blend-mode: multiply; }

        .card-title { font-size: 18px; font-weight: 700; color: var(--font-color); margin-top: 5px; line-height: 1.2; }
        .card-subtitle { font-size: 13px; color: var(--font-color-sub); flex-grow: 1; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; line-height: 1.4; }
        .card-divider { width: 100%; border: 1px solid #eee; margin: 5px 0; }
        .card-footer { display: flex; justify-content: space-between; align-items: center; }
        .card-price { font-size: 20px; font-weight: 600; color: var(--font-color); }
        .card-btn { height: 35px; width: 35px; background: var(--bg-color); border: 2px solid var(--main-color); border-radius: 5px; display: flex; align-items: center; justify-content: center; transition: all 0.3s; cursor: pointer; }
        .card-btn svg { width: 18px; height: 18px; fill: var(--main-color); transition: all 0.3s; }
        .card-btn:hover { border-color: var(--main-focus); background: var(--main-focus); }
        .card-btn:hover svg { fill: white; }

        /* --- PREMIUM MODAL STYLES --- */
        .modal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:100; display:flex; justify-content:center; align-items:center; opacity:0; pointer-events:none; transition:0.3s ease; backdrop-filter:blur(5px); }
        .modal.active { opacity:1; pointer-events:auto; }
        
        .modal-box { 
            background: white; 
            border-radius: 24px; 
            max-width: 1000px; 
            width: 95%; 
            height: 85vh; /* Fixed height for consistent layout */
            max-height: 700px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            display: flex;
            overflow: hidden;
            position: relative;
        }

        .detail-left { 
            width: 50%; 
            background-color: #f3f4f6; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 40px; 
        }
        
        .detail-left img { 
            max-width: 100%; 
            max-height: 100%; 
            object-fit: contain; 
            filter: drop-shadow(0 15px 30px rgba(0,0,0,0.15)); /* Premium floating effect */
            mix-blend-mode: multiply;
        }

        .detail-right { 
            width: 50%; 
            padding: 50px 40px; 
            overflow-y: auto; 
            display: flex; 
            flex-direction: column;
        }

        .close-btn { 
            position: absolute; 
            top: 20px; 
            right: 20px; 
            background: rgba(0,0,0,0.05); 
            border: none; 
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            cursor: pointer; 
            font-size: 1.5rem; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: 0.2s;
            z-index: 10;
            color: #555;
        }
        .close-btn:hover { background: rgba(0,0,0,0.1); color: #000; }

        /* Detail Typography */
        #dName { font-size: 2.5rem; font-weight: 800; color: #1a1a1a; margin-bottom: 10px; line-height: 1.1; letter-spacing: -1px; }
        #dPrice { font-size: 1.8rem; color: var(--primary); font-weight: 700; }
        #dDesc { font-size: 1rem; line-height: 1.6; color: #555; margin-bottom: 25px; }
        
        /* Stock Badge */
        .modal-stock-badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            background: #f0fdf4;
            color: var(--primary);
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 20px;
            align-self: flex-start;
        }
        .modal-stock-badge.low { background: #fef2f2; color: #ef4444; }

        /* Add Button */
        #addBtn {
            width: 100%;
            padding: 18px;
            font-size: 1.1rem;
            border-radius: 12px;
            margin-bottom: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        /* Reviews Section */
        .reviews { margin-top: auto; padding-top: 30px; border-top: 1px solid #eaeaea; }
        .reviews h3 { font-size: 1.2rem; font-weight: 700; margin-bottom: 15px; }
        
        .review-form { background: #f9fafb; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #eee; }
        .config-input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #e5e7eb; border-radius: 8px; background: white; font-family: inherit; }
        .config-input:focus { outline: 2px solid var(--primary); border-color: transparent; }
        
        .star-widget { font-size: 1.5rem; color: #d1d5db; cursor: pointer; margin-bottom: 10px; }
        .star-widget span:hover, .star-widget span.active { color: #facc15; }
        
        .review-item { padding: 15px 0; border-bottom: 1px solid #f3f4f6; }
        .review-item:last-child { border-bottom: none; }
        
        /* CART SIDEBAR */
        .cart-sidebar { position: fixed; top: 0; right: -400px; width: 400px; height: 100%; background: white; z-index: 200; box-shadow: -10px 0 40px rgba(0,0,0,0.1); transition: 0.4s cubic-bezier(0.16, 1, 0.3, 1); display: flex; flex-direction: column; }
        .cart-sidebar.open { right: 0; }
        .cart-header { padding: 25px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .cart-header h3 { font-size: 1.5rem; font-weight: 700; }
        .cart-items { flex: 1; overflow-y: auto; padding: 25px; }
        .cart-footer { padding: 30px; border-top: 1px solid #eee; background: #f9fafb; }
        .cart-item { display: flex; gap: 15px; margin-bottom: 20px; border-bottom: 1px solid #f3f4f6; padding-bottom: 20px; align-items: center; }
        .qty-controls { display: flex; align-items: center; gap: 10px; margin-top: 5px; }
        .qty-btn { width: 28px; height: 28px; border-radius: 50%; border: 1px solid #e5e7eb; background: white; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1rem; transition: 0.2s; }
        .qty-btn:hover { background: #f3f4f6; border-color: #d1d5db; }
        .cart-item img { width: 70px; height: 70px; object-fit: cover; border-radius: 10px; border: 1px solid #eee; }
        .cart-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 150; opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(2px); }
        .cart-overlay.open { opacity: 1; pointer-events: auto; }
        
        .user-menu { display: flex; align-items: center; gap: 10px; }
        .auth-btn { font-size: 0.85rem; font-weight: 600; cursor: pointer; color: var(--primary); background: #e9f3eb; padding: 8px 16px; border-radius: 20px; transition: 0.2s; }
        .auth-btn:hover { background: var(--primary); color: white; }

        @media(max-width:900px) { 
            .modal-box { flex-direction: column; height: 95vh; overflow-y: auto; } 
            .detail-left { width: 100%; height: 300px; padding: 20px; }
            .detail-right { width: 100%; padding: 30px; overflow-y: visible; }
            .cart-sidebar { width: 100%; }
        }
    </style>
</head>
<body>

    <!-- CART SIDEBAR -->
    <div class="cart-overlay" id="cartOverlay" onclick="toggleCart()"></div>
    <div class="cart-sidebar" id="cartSidebar">
        <div class="cart-header">
            <h3>Your Cart</h3>
            <button class="close-btn" style="position:static; width:35px; height:35px;" onclick="toggleCart()">&times;</button>
        </div>
        <div class="cart-items" id="cartItemsContainer"></div>
        <div class="cart-footer">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px; font-weight:700; font-size:1.2rem;">
                <span>Total</span>
                <span id="cartTotal">$0.00</span>
            </div>
            <button class="btn" style="width:100%; padding: 15px;" onclick="checkout()">Secure Checkout</button>
        </div>
    </div>

    <!-- HIGH-LEVEL PRODUCT MODAL -->
    <div id="productModal" class="modal">
        <div class="modal-box">
            <button class="close-btn" onclick="closeModal('productModal')">&times;</button>
            
            <div class="detail-left">
                <img id="dImg" src="" alt="Product">
            </div>
            
            <div class="detail-right">
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <div>
                        <h2 id="dName">Product Name</h2>
                        <div id="dStockBadge" class="modal-stock-badge">In Stock</div>
                    </div>
                    <span id="dPrice">$0.00</span>
                </div>

                <div style="display:flex; align-items: center; gap: 8px; margin-bottom: 20px;">
                    <div id="dStars" style="color:#facc15; display:flex;"></div>
                    <span style="font-size: 0.9rem; color: #888; font-weight: 500;">(Customer Reviews)</span>
                </div>

                <!-- Description Field -->
                <p id="dDesc">No description available.</p>
                
                <button id="addBtn" class="btn" onclick="addToCart(curId)">
                    <i data-lucide="shopping-bag" style="width:20px;"></i> Add to Cart
                </button>

                <div class="reviews">
                    <h3>Customer Reviews</h3>
                    <div class="review-form">
                        <input id="rName" class="config-input" style="margin-top:0" placeholder="Your Name">
                        <div class="star-widget" id="starWidget">
                            <span onclick="rate(1)">★</span><span onclick="rate(2)">★</span><span onclick="rate(3)">★</span><span onclick="rate(4)">★</span><span onclick="rate(5)">★</span>
                        </div>
                        <textarea id="rText" class="config-input" placeholder="Share your thoughts..." rows="2"></textarea>
                        <button class="btn" style="font-size:0.85rem; padding: 10px 20px;" onclick="postReview()">Post Review</button>
                    </div>
                    <div id="rList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- HEADER -->
    <header>
        <div class="container nav">
            <div class="logo">flow <i data-lucide="leaf"></i></div>
            <div class="nav-links">
                <a href="#">Shop</a>
                <a href="#">Our Story</a>
                
                <!-- Cart Icon -->
                <a onclick="toggleCart()" style="display:flex; align-items:center; gap:5px;">
                    <i data-lucide="shopping-cart" style="width:18px;"></i>
                    <span id="cartCount" style="background:var(--primary); color:white; font-size:0.7rem; padding:2px 6px; border-radius:10px;">0</span>
                </a>

                <!-- Auth Section -->
                <div id="authSection" class="user-menu">
                    <!-- Injected via JS -->
                </div>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <div class="container">
        <div class="hero">
            <h1>Sustainable Living.</h1>
            <p>Curated eco-friendly essentials for a balanced, mindful lifestyle.</p>
        </div>
        <div id="loader" style="text-align:center; padding: 40px; color: #888;">Loading collection...</div>
        <div id="grid" class="grid"></div>
    </div>

    <!-- LOGIC -->
    <script>
        const SUPABASE_URL = 'https://rbjxpbogrjlfdqpirbyj.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJianhwYm9ncmpsZmRxcGlyYnlqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3MDU1OTksImV4cCI6MjA4MDI4MTU5OX0.0dEtjUKYBMO2m-JwSAvwTA-9kZB7e6asrhTULlHevjs';

        let sb = null, products = [], curId = null, curRating = 0;
        let cart = JSON.parse(localStorage.getItem('flow_cart')) || [];
        let user = null;

        window.onload = async () => {
            lucide.createIcons();
            sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            
            // CHECK AUTH STATE
            const { data } = await sb.auth.getUser();
            user = data.user;
            updateAuthUI();

            fetchProducts();
            updateCartUI(); 
        };

        function updateAuthUI() {
            const authSection = document.getElementById('authSection');
            if (user) {
                authSection.innerHTML = `
                    <span style="font-size:0.8rem; color:#666;">Hi, ${user.email.split('@')[0]}</span>
                    <span class="auth-btn" onclick="logout()">Logout</span>
                `;
            } else {
                authSection.innerHTML = `<a href="login.html" class="auth-btn">Login / Sign Up</a>`;
            }
        }

        async function logout() {
            await sb.auth.signOut();
            window.location.reload();
        }

        async function fetchProducts() {
            // Fetch everything including description
            const { data, error } = await sb.from('products').select('*').order('id');
            document.getElementById('loader').classList.add('hidden');
            if(!error) {
                products = data;
                const grid = document.getElementById('grid');
                grid.innerHTML = '';
                if(data.length === 0) grid.innerHTML = '<p style="text-align:center; width:100%;">No products found.</p>';
                
                data.forEach(p => {
                    const subtitle = p.description || (p.stock > 0 
                        ? `Eco-friendly sustainable choice. Only ${p.stock} units left in stock!` 
                        : `Currently out of stock. Please check back later.`);

                    grid.innerHTML += `
                    <div class="card" onclick="openProduct(${p.id})">
                        <div class="card-img"><img src="${p.image_url}" class="img" alt="${p.name}"></div>
                        <div class="card-title">${p.name}</div>
                        <div class="card-subtitle">${subtitle}</div>
                        <hr class="card-divider">
                        <div class="card-footer">
                            <div class="card-price"><span>$</span> ${p.price}</div>
                            <button class="card-btn" onclick="event.stopPropagation(); addToCart(${p.id})">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="m397.78 316h-205.13a15 15 0 0 1 -14.65-11.67l-34.54-150.48a15 15 0 0 1 14.62-18.36h274.27a15 15 0 0 1 14.65 18.36l-34.6 150.48a15 15 0 0 1 -14.62 11.67zm-193.19-30h181.25l27.67-120.48h-236.6z"></path><path d="m222 450a57.48 57.48 0 1 1 57.48-57.48 57.54 57.54 0 0 1 -57.48 57.48zm0-84.95a27.48 27.48 0 1 0 27.48 27.47 27.5 27.5 0 0 0 -27.48-27.47z"></path><path d="m368.42 450a57.48 57.48 0 1 1 57.48-57.48 57.54 57.54 0 0 1 -57.48 57.48zm0-84.95a27.48 27.48 0 1 0 27.48 27.47 27.5 27.5 0 0 0 -27.48-27.47z"></path><path d="m158.08 165.49a15 15 0 0 1 -14.23-10.26l-25.71-77.23h-47.44a15 15 0 1 1 0-30h58.3a15 15 0 0 1 14.23 10.26l29.13 87.49a15 15 0 0 1 -14.23 19.74z"></path></svg>
                            </button>
                        </div>
                    </div>`;
                });
            } else {
                document.getElementById('grid').innerHTML = '<p style="color:red">Error loading products.</p>';
            }
        }

        async function openProduct(id) {
            curId = id;
            const p = products.find(x => x.id === id);
            
            document.getElementById('dImg').src = p.image_url;
            document.getElementById('dName').innerText = p.name;
            document.getElementById('dPrice').innerText = '$' + p.price;
            document.getElementById('dDesc').innerText = p.description || "No specific details available for this product.";
            
            const badge = document.getElementById('dStockBadge');
            const addBtn = document.getElementById('addBtn');
            
            if (p.stock > 0) {
                badge.innerText = `In Stock (${p.stock})`;
                badge.className = 'modal-stock-badge';
                addBtn.disabled = false;
                addBtn.style.opacity = "1";
                addBtn.style.cursor = "pointer";
                addBtn.innerHTML = `<i data-lucide="shopping-bag" style="width:20px; margin-right:5px;"></i> Add to Cart`;
            } else {
                badge.innerText = `Out of Stock`;
                badge.className = 'modal-stock-badge low';
                addBtn.disabled = true;
                addBtn.style.opacity = "0.5";
                addBtn.style.cursor = "not-allowed";
                addBtn.innerHTML = `Sold Out`;
            }

            document.getElementById('productModal').classList.add('active');
            lucide.createIcons(); // Refresh icons inside modal
            rate(0); document.getElementById('rName').value=''; document.getElementById('rText').value='';
            loadReviews(id);
        }

        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        function toggleCart() {
            document.getElementById('cartSidebar').classList.toggle('open');
            document.getElementById('cartOverlay').classList.toggle('open');
        }

        function updateQty(id, change) {
            const item = cart.find(i => i.id === id);
            const product = products.find(p => p.id === id);

            if(item) {
                if (change > 0 && item.qty >= product.stock) {
                    return alert(`Sorry, only ${product.stock} available!`);
                }
                
                item.qty += change;
                if(item.qty <= 0) {
                    removeFromCart(id);
                } else {
                    saveCart();
                    updateCartUI();
                }
            }
        }

        async function checkout() {
            if(cart.length === 0) return alert("Your cart is empty!");
            
            if (!user) {
                if(confirm("You must be logged in to checkout. Go to login page?")) {
                    window.location.href = 'login.html';
                }
                return;
            }

            const name = prompt("Please enter your name to confirm order:");
            if(!name) return;

            const total = cart.reduce((a, c) => a + c.price * c.qty, 0);
            
            const { data: order, error: orderError } = await sb
                .from('orders')
                .insert([{ customer_name: name, total_amount: total }])
                .select()
                .single();

            if(orderError) return alert("Checkout Failed: " + orderError.message);

            for (const item of cart) {
                await sb.from('order_items').insert([{
                    order_id: order.id,
                    product_id: item.id,
                    quantity: item.qty,
                    price: item.price
                }]);

                const product = products.find(p => p.id === item.id);
                const newStock = Math.max(0, product.stock - item.qty);
                await sb.from('products').update({ stock: newStock }).eq('id', item.id);
            }

            alert("Order Placed Successfully!");
            cart = [];
            saveCart();
            updateCartUI();
            toggleCart();
            fetchProducts();
        }

        function addToCart(id) {
            if (!user) {
                if(confirm("Guests cannot add items to cart. Would you like to login?")) {
                    window.location.href = 'login.html';
                }
                return;
            }

            const product = products.find(p => p.id === id);
            const existing = cart.find(item => item.id === id);

            const currentQtyInCart = existing ? existing.qty : 0;
            if (currentQtyInCart + 1 > product.stock) {
                return alert("Cannot add more. We are out of stock!");
            }

            if(existing) {
                existing.qty++;
            } else {
                cart.push({ ...product, qty: 1 });
            }
            
            saveCart();
            updateCartUI();
            toggleCart(); 
        }

        function removeFromCart(id) {
            cart = cart.filter(item => item.id !== id);
            saveCart();
            updateCartUI();
        }

        function saveCart() {
            localStorage.setItem('flow_cart', JSON.stringify(cart));
        }

        function updateCartUI() {
            const count = cart.reduce((acc, item) => acc + item.qty, 0);
            document.getElementById('cartCount').innerText = count;

            const container = document.getElementById('cartItemsContainer');
            container.innerHTML = '';
            let total = 0;

            if(cart.length === 0) {
                container.innerHTML = '<div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; color:#999;"><i data-lucide="shopping-bag" style="width:40px; height:40px; margin-bottom:10px; opacity:0.3;"></i><p>Your cart is empty.</p></div>';
            }

            cart.forEach(item => {
                total += item.price * item.qty;
                container.innerHTML += `
                    <div class="cart-item">
                        <img src="${item.image_url}" alt="img">
                        <div style="flex:1">
                            <div style="font-weight:600; font-size:0.9rem; margin-bottom:4px;">${item.name}</div>
                            <div style="color:var(--primary); font-weight:700;">$${item.price}</div>
                            <div class="qty-controls">
                                <button class="qty-btn" onclick="updateQty(${item.id}, -1)">-</button>
                                <span style="font-weight:600; font-size:0.9rem;">${item.qty}</span>
                                <button class="qty-btn" onclick="updateQty(${item.id}, 1)">+</button>
                            </div>
                        </div>
                        <button onclick="removeFromCart(${item.id})" style="border:none; background:none; color:#ef4444; cursor:pointer; padding:5px;" title="Remove Item">
                            <i data-lucide="trash-2" style="width:18px;"></i>
                        </button>
                    </div>
                `;
            });

            lucide.createIcons();
            document.getElementById('cartTotal').innerText = '$' + total.toFixed(2);
        }

        function rate(n) {
            curRating = n;
            Array.from(document.getElementById('starWidget').children).forEach((s,i) => {
                s.className = i < n ? 'active' : '';
            });
        }

        async function loadReviews(pid) {
            const list = document.getElementById('rList');
            list.innerHTML = '<p style="color:#888; font-style:italic;">Loading reviews...</p>';
            const { data } = await sb.from('reviews').select('*').eq('product_id', pid).order('created_at',{ascending:false});
            list.innerHTML = '';
            
            const starsContainer = document.getElementById('dStars');
            
            if(data && data.length > 0) {
                const avg = data.reduce((a,b)=>a+b.rating,0)/data.length;
                const roundedAvg = Math.round(avg);
                
                // Render Stars in Header
                let starsHtml = '';
                for(let i=0; i<5; i++) {
                    starsHtml += `<i data-lucide="star" style="width:16px; fill:${i < roundedAvg ? '#facc15' : 'none'}; stroke:${i < roundedAvg ? 'none' : '#d1d5db'}"></i>`;
                }
                starsContainer.innerHTML = starsHtml;
                lucide.createIcons();

                data.forEach(r => {
                    list.innerHTML += `
                    <div class="review-item">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <strong style="font-size:0.9rem;">${r.user_name}</strong>
                            <span style="color:#facc15; font-size:0.8rem;">${'★'.repeat(r.rating)}</span>
                        </div>
                        <p style="font-size:0.9rem; color:#444; line-height:1.4;">${r.comment}</p>
                    </div>`;
                });
            } else {
                starsContainer.innerHTML = '<span style="color:#9ca3af; font-size:0.9rem;">No ratings yet</span>';
                list.innerHTML = '<p style="color:#9ca3af; font-style:italic;">No reviews yet. Be the first!</p>';
            }
        }

        async function postReview() {
            const name = document.getElementById('rName').value;
            const txt = document.getElementById('rText').value;
            if(!name || curRating === 0) return alert('Name and Rating required');
            await sb.from('reviews').insert([{product_id: curId, user_name: name, rating: curRating, comment: txt}]);
            loadReviews(curId);
        }
    </script>
</body>
</html>